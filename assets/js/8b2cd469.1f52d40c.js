"use strict";(self.webpackChunkinterview_guide=self.webpackChunkinterview_guide||[]).push([[138],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>u});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),c=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},s=function(e){var t=c(e.components);return r.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),d=c(n),u=a,k=d["".concat(p,".").concat(u)]||d[u]||m[u]||o;return n?r.createElement(k,l(l({ref:t},s),{},{components:n})):r.createElement(k,l({ref:t},s))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=d;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var c=2;c<o;c++)l[c]=n[c];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},819:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var r=n(7462),a=(n(7294),n(3905));const o={sidebar_position:4},l="docker-compose.yaml",i={unversionedId:"docker/docker-compose",id:"docker/docker-compose",title:"docker-compose.yaml",description:"docker-compose allow us to start multiple container services at a time. The configuration is written in YAML format",source:"@site/docs/docker/docker-compose.mdx",sourceDirName:"docker",slug:"/docker/docker-compose",permalink:"/docker/docker-compose",draft:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Dockerfile",permalink:"/docker/dockerfile"},next:{title:"End to End Dockerization",permalink:"/docker/end-to-end-dockerization"}},p={},c=[{value:"Sample",id:"sample",level:2},{value:"Dockerfile",id:"dockerfile",level:3},{value:"docker-compose.yaml",id:"docker-composeyaml-1",level:3},{value:"docker-compose file explained",id:"docker-compose-file-explained",level:3},{value:"Starting multiple containers with docker-compose.yaml",id:"starting-multiple-containers-with-docker-composeyaml",level:3},{value:"Networking in Docker",id:"networking-in-docker",level:2},{value:"Fixing DB Connection between MySQL container and SpringBoot container",id:"fixing-db-connection-between-mysql-container-and-springboot-container",level:3}],s={toc:c};function m(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"docker-composeyaml"},"docker-compose.yaml"),(0,a.kt)("p",null,"docker-compose allow us to start multiple container services at a time. The configuration is written in YAML format"),(0,a.kt)("h2",{id:"sample"},"Sample"),(0,a.kt)("p",null,"Lets assume we have a EmployeeApp built using SpringBoot REST & uses MySQL for DB. Below is the sample for doing end to end containerization of the EmployeeApp application. "),(0,a.kt)("h3",{id:"dockerfile"},"Dockerfile"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'FROM openjdk:8-jdk-alpine\nCOPY EmployeeApp.jar EmployeeApp.jar\nCMD ["java", "-jar", "EmpApp.jar"]\n')),(0,a.kt)("h3",{id:"docker-composeyaml-1"},"docker-compose.yaml"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"version : '3'\nservices :\n  webapp :\n    build : .\n    image : employee-app\n    ports :\n      - \"8080:8080\"\n  dbapp :\n    image : mysql:5.7\n    restart : always\n    environment :\n      MYSQL_DATABASE : 'MY_DB'\n      MYSQL_ROOT_PASSWORD : 'rootroot'\n    expose :\n      - \"3306\"\n    ports :\n      - \"3306:3306\"\n    volumes :\n      - ./sqlscript:/docker-entrypoint-initdb.d\n      - ./data:/var/lib/mysql\n")),(0,a.kt)("h3",{id:"docker-compose-file-explained"},"docker-compose file explained"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Docker-compose"),(0,a.kt)("th",{parentName:"tr",align:null},"Value"),(0,a.kt)("th",{parentName:"tr",align:null},"Description"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"version"),(0,a.kt)("td",{parentName:"tr",align:null},"3"),(0,a.kt)("td",{parentName:"tr",align:null},"Version of Docker compose we want to use. It should be the first line in docker-compose.yaml file")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"services"),(0,a.kt)("td",{parentName:"tr",align:null}),(0,a.kt)("td",{parentName:"tr",align:null},"Configuration for each Docker container we want, is specified under services")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"webapp"),(0,a.kt)("td",{parentName:"tr",align:null}),(0,a.kt)("td",{parentName:"tr",align:null},"User provided name for the Spring Boot web app service")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"build"),(0,a.kt)("td",{parentName:"tr",align:null},". (Dot)"),(0,a.kt)("td",{parentName:"tr",align:null},"Specify Dockerfile location. Use (Dot) if the Dockerfile & docker-compose.yaml are in same directory")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"image"),(0,a.kt)("td",{parentName:"tr",align:null},"my-img"),(0,a.kt)("td",{parentName:"tr",align:null},"Custom Image name")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"ports"),(0,a.kt)("td",{parentName:"tr",align:null},"8080:8080"),(0,a.kt)("td",{parentName:"tr",align:null},"Ports we want to expose outside of Docker container. The format is <HOST_IP>:<CONTAINER_IP>")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"dbapp"),(0,a.kt)("td",{parentName:"tr",align:null}),(0,a.kt)("td",{parentName:"tr",align:null},"User provided name for the Database container service")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"image"),(0,a.kt)("td",{parentName:"tr",align:null},"mysql:5.7"),(0,a.kt)("td",{parentName:"tr",align:null},"Image name & its version to download from docker hub")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"restart"),(0,a.kt)("td",{parentName:"tr",align:null},"always"),(0,a.kt)("td",{parentName:"tr",align:null},"To restart the container every time")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"environment"),(0,a.kt)("td",{parentName:"tr",align:null}),(0,a.kt)("td",{parentName:"tr",align:null},"Environment variables we want to pass while starting the MySQL Container")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"MYSQL_DATABASE"),(0,a.kt)("td",{parentName:"tr",align:null},"MY_DB"),(0,a.kt)("td",{parentName:"tr",align:null},"Database to be created on Container startup")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"MYSQL_ROOT_PASSWORD"),(0,a.kt)("td",{parentName:"tr",align:null},"Rootroot"),(0,a.kt)("td",{parentName:"tr",align:null},"Password for MySQL Root user account")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"expose"),(0,a.kt)("td",{parentName:"tr",align:null},"8080"),(0,a.kt)("td",{parentName:"tr",align:null},"Port to be exposed for inter container communication")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"ports"),(0,a.kt)("td",{parentName:"tr",align:null},"8080:8080"),(0,a.kt)("td",{parentName:"tr",align:null},"Ports we want to expose outside of Docker container. The format is <HOST_IP>:<CONTAINER_IP>")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"volumes"),(0,a.kt)("td",{parentName:"tr",align:null},"./data:/var/lib/mysql"),(0,a.kt)("td",{parentName:"tr",align:null},"Volumes we want to mount from host to Docker container")))),(0,a.kt)("h3",{id:"starting-multiple-containers-with-docker-composeyaml"},"Starting multiple containers with docker-compose.yaml"),(0,a.kt)("p",null,"In order to start the application, use either of the following commands"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"> docker-compose up\n\nor\n\n> docker-compose up --build\n")),(0,a.kt)("hr",null),(0,a.kt)("h2",{id:"networking-in-docker"},"Networking in Docker"),(0,a.kt)("p",null,"In above docker-compose sample, we have started two containers, one for Employee Web Application & other is for MySQL Database. Typically when we want to connect Web application with MySQL, we use ",(0,a.kt)("strong",{parentName:"p"},"connection string")," like below"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"spring.datasource.url=jdbc:mysql://<b>localhost:3306</b>/MY_DB?useSSL=false&allowPublicKeyRetrieval=true\n")),(0,a.kt)("p",null,"3306 is the default port of MySQL server. "),(0,a.kt)("p",null,"After we containerized the entire application, MySQL will run in its own container (read as its own operating system) whereas the Spring Boot application will be running in its own container.\nSo localhost of SpringBoot container is not the localhost of MySQL container. Hence connecting with localhost:3306 from SpringBoot container is not gonna work"),(0,a.kt)("p",null,"Hence we need to rely on the networking capabilities of the docker-compose to make inter-container communication possible"),(0,a.kt)("p",null,"When we start application using ",(0,a.kt)("inlineCode",{parentName:"p"},"docker-compose up"),", docker-compose creates a default network bridge between all the containers it start. We can refer to any container started by docker-compose using this default network bridge using the name given for the container in docker-compose.yaml file"),(0,a.kt)("h3",{id:"fixing-db-connection-between-mysql-container-and-springboot-container"},"Fixing DB Connection between MySQL container and SpringBoot container"),(0,a.kt)("p",null,"Replace the localhost in connection string with name given for docker container in docker-compose.yaml file can fix the inter-container communication"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"spring.datasource.url=jdbc:mysql://<del>localhost</del>:3306/ORDER_DB?useSSL=false&allowPublicKeyRetrieval=true\n\nspring.datasource.url=jdbc:mysql://**dbapp**:3306/ORDER_DB?useSSL=false&allowPublicKeyRetrieval=true\n")),(0,a.kt)("p",null,"dbapp is nothing but the name we given for the MySQL image in docker-compose.yaml file. Refer to line 31 above for dpapp"))}m.isMDXComponent=!0}}]);